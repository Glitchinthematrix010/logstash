
filter {
  if [type] == "389-Directory" {
    if [source] =~ /access$/ {
      if [original] == "" {
        drop { }
      }
      grok {
        patterns_dir   => [ "/etc/logstash/patterns.d" ]
        tag_on_failure => [ ]
        add_tag        => [ "Known Message" ]
        overwrite      => [ "message", "[@metadata][timestamp]" ]
        match          => { "original" => [
            "^\t%{HOST_SRC}:%{PORT_SRC} \(%{PATH}\)$",
            "^\t389-Directory/[0-9.]+ B[0-9.]+$",
            "^\[%{DS389TIMESTAMP:[@metadata][timestamp]}\] %{DS389EVENT:message}$"
        ] }
      }
      if [@metadata][389dsparams1] {
        kv {
          source      => "[@metadata][389dsparams1]"
          trim        => '\"'
          target      => "[389ds][access]" 
        }
      }
      if [@metadata][389dsparams2] {
        kv {
          source      => "[@metadata][389dsparams2]"
          trim        => '\"'
          target      => "[389ds][access]" 
        }
      }
      date {
        match => [ "[@metadata][timestamp]" , "dd/MMM/yyyy:HH:mm:ss Z" ]
        target => "@timestamp"
        add_field => { "debug" => "timestamp_applied" }
      }
    }
    if [source] =~ /errors$/ {
      grok {
        patterns_dir   => [ "/etc/logstash/patterns.d" ]
        tag_on_failure => [ ]
        add_tag        => [ "Known Message", "Error" ]
        overwrite      => [ "message", "[@metadata][timestamp]" ]
        match          => { "original" => [
          "^\[%{DS389TIMESTAMP:[@metadata][timestamp]}\] slapd_ldap_sasl_interactive_bind - Error: could not perform interactive bind for id \[\] mech \[GSSAPI\]: LDAP error -1 \(Can't contact LDAP server\) \(\(null\)\) errno 107 \(Transport endpoint is not connected\)$",
          "^\[%{DS389TIMESTAMP:[@metadata][timestamp]}\] slapi_ldap_bind - Error: could not perform interactive bind for id \[\] authentication mechanism \[GSSAPI\]: error -1 \(Can't contact LDAP server\)$",
          "^\[%{DS389TIMESTAMP:[@metadata][timestamp]}\] slapi_ldap_bind - Error: could not send startTLS request: error -1 \(Can't contact LDAP server\) errno 107 \(Transport endpoint is not connected\)$"
        ] }
      }
    }
  }
}
