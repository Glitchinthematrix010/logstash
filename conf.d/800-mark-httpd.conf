filter {
  if [type] == "apache_access" {
    if [http][request][uri] {
      mutate {
        replace => { "message" => "%{[http][request][uri]}" }
      }
    } else if [http][request][raw] { 
      mutate {
        replace => { "message" => "%{[http][request][raw]}" }
      }
    } 
    if [message] and [http][response][code] and [http][response][code] < 400 {
      grok {
        patterns_dir => [ "/etc/logstash/patterns.d/" ]
        tag_on_failure => [ ]
        add_tag => [ "Known Message", "Benign" ]
        match => { "message" => [
          "^/$",
          "^/mod_pagespeed_beacon\?url=",
          "^/$",
          "^\*$"
        ] }
      }
    }
    if [http][response][code] and [http][response][code] >= 400 and [http][response][code] < 408 {
      mutate {
        add_tag => [ "Known Message", "Possible Probe" ]
      }
    }  
    if [http][response][code] == 408 {
      mutate {
        add_tag => [ "Known Message", "Benign" ]
      }
    }  
    if [http][response][code] == 409 and [message] =~ /^\/kibana\/elasticsearch\/\.kibana\/.*\?op_type=create$/ {
      mutate {
        add_tag => [ "Known Message", "Benign" ]
      }
    }
  }
  if [type] == "apache_error" {
    mutate {
      add_field => { "message" => "%{original}" }
    }
    grok {
      add_tag        => [ "Known Message","Error" ]
      tag_on_failure => [ ]
      match          => { "message" => [
        "^\[:warn\] \[pid %{INT:[syslog][pid]}\] NSSSessionCacheTimeout is deprecated\. Ignoring\.$",
        "^\[auth_digest:notice\] \[pid %{INT:[syslog][pid]}\] AH01757: generating secret for digest authentication \.\.\.$",
        "^\[core:notice\] \[pid %{INT:[syslog][pid]}\] AH00094: Command line: '/usr/sbin/httpd -D FOREGROUND'$",
        "^\[lbmethod_heartbeat:notice\] \[pid %{INT:[syslog][pid]}\] AH02282: No slotmem from mod_heartmonitor$",
        "^\[mpm_prefork:error\] \[pid %{POSINT:[syslog][pid]}\] AH00161: server reached MaxRequestWorkers setting, consider raising the MaxRequestWorkers setting$",
        "^\[mpm_prefork:notice\] \[pid %{INT:[syslog][pid]}\] AH00163: Apache/[0-9.]+ \(%{DATA}\) ((a-zA-Z0-9_)+/[0-9.]+ |Basic ECC )*configured -- resuming normal operations$",
        "^ipa: INFO: *** PROCESS START ***$"
      ] }
    }
  }
}
